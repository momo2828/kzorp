#cloud-config
password: zorp
chpasswd: { expire: False }
ssh_pwauth: True
packages: 
 - git
 - build-essential
 - autoconf
 - libtool
 - python-prctl
 - python-nose
 - linux-headers-generic
hostname: ubuntu
manage_etc_hosts: localhost
runcmd:
 - set -x
 - mkdir -p /tmp/kzorp_test_run/tests
 - sudo mount -t 9p -o trans=virtio,version=9p2000.L hostshare /tmp/kzorp_test_run/tests
 - cd
 - git clone https://github.com/momo2828/kzorp.git
 - cd kzorp
 - git checkout travis
 - autoreconf -i
 - ./configure
 - sudo make install-driver
 - TEST_PYTHONPATH=$PWD/pylib:$PWD/driver/tests/base
 - TEST_FILES=`find driver/tests/ -name KZorpTestCase\*.py -printf "%p "`
 - if [ ! -z  ] 
 - then 
 - echo clear | sudo tee /sys/kernel/debug/kmemleak 
 - fi
 - sudo bash -c "PYTHONPATH=$PYTHONPATH:$TEST_PYTHONPATH nosetests --with-xunit $TEST_FILES"
 - if [ ! -z  ] 
 - then 
 - sleep 5
 - echo scan | sudo tee /sys/kernel/debug/kmemleak # kmemleak is more reliable when scanning twice:
 - echo scan | sudo tee /sys/kernel/debug/kmemleak # http://stackoverflow.com/questions/12943906/debug-kernel-module-memory-corruption
 - sudo cp /sys/kernel/debug/kmemleak /tmp/kzorp_test_run/tests/kmemleak 
 - fi
 - cp nosetests.xml /tmp/kzorp_test_run/tests/result.xml
 - sudo poweroff
